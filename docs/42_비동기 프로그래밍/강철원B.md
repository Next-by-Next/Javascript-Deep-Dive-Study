**TIL(Today I learn) 기록일** : 2023.01.25

# 42. 비동기 프로그래밍

## 1. 동기 처리와 비동기 처리

![image](https://github.com/Ryan-Dia/Javascript-Deep-Dive-Study/assets/76567238/dd27d014-2459-4e91-8a32-24b64044340b)   
<출처 : 오픈마루 연구소>

**자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖습니다.** 때문에 실행 컨텍스트 스택의 최상위 요소인 `실행 중인 실행 컨텍스트`를 제외한 모든 실행 컨테긋트는 모두 실행 대기 중인 태스크입니다. 현재 실행중인 함수가 종료하면 비로소 실행되기 시작합니다.    

이처럼 자바스크립트 엔진은 한 번에 하나의 태스크만 실행할 수 잇는 `싱글 스레드`방식으로 동작합니다. 싱글 스레드 방식은 한 번에 하나의 태스만 실행할 수 있기 때문에 처리에 시간이 걸리는 태스크를 실행하는 경우 `블로킹(작업 중단)`이 발생합니다.     
>다음은 `setTimeout`함수와 유사하게 일정 시간이 경과한 이후에 콜백 함수를 호출하는 `sleep`함수를 입니다.
```js
// sleep 함수는 일정 시간(delay)이 경과한 이후에 콜백 함수(func)를 호출한다.
function sleep(func, delay) {
  // Date.now()는 현재 시간을 숫자(ms)로 반환한다.("30.2.1. Date.now" 참고)
  const delayUntil = Date.now() + delay;

  // 현재 시간(Date.now())에 delay를 더한 delayUntil이 현재 시간보다 작으면 계속 반복한다.
  while (Date.now() < delayUntil);
  // 일정 시간(delay)이 경과한 이후에 콜백 함수(func)를 호출한다.
  func();
}

function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

// sleep 함수는 3초 이상 실행된다..
sleep(foo, 3 * 1000);
// bar 함수는 sleep 함수의 실행이 종료된 이후에 호출되므로 3초 이상 블로킹된다.
bar();
// (3초 경과 후) foo 호출 -> bar 호출
```

- 위 예제처럼 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대가하는 방식을 `동기처리`라고 합니다.
- 동기 처리 방식은 태스크를 순서대로 하나씩 처리하므로 실행 순서가 보장된다는 장점이 있지만, 앞선 태스크가 종료할 때까지 이후 태스크들이 블로킹되는 단점이 있습니다.


![image](https://github.com/Ryan-Dia/Javascript-Deep-Dive-Study/assets/76567238/f9558735-3410-48db-9684-c46a9e9b8dd0)


위 예제에서 타이머 함수인 `setTimeout(블로킹을 하지 않음)`을 사용하면 아래와 같습니다.

```js
function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

// 타이머 함수 setTimeout은 일정 시간이 경과한 이후에 콜백 함수 foo를 호출한다.
// 타이머 함수 setTimeout은 bar 함수를 블로킹하지 않는다.
setTimeout(foo, 3 * 1000);
bar();
// bar 호출 -> (3초 경과 후) foo 호출
```

- 이처럼 현재 실행 중인 태스크가 종료되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식을 `비동기 처리`라고 합니다.

![image](https://github.com/Ryan-Dia/Javascript-Deep-Dive-Study/assets/76567238/943519e4-6168-4f71-ab46-89b965805ec7)


**❗️타이머 함수인 setTimeout과 setInterval, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작합니다.**

<br>

## 2. 이벤트 루프와 태스크 큐

자바스크립트의 동시성을 지원하는 것이 바로 `이벤트 루프(event loop)`입니다.

>이벤트 루프는 브라우저에 내장되어 있는 기능 중 하나입니다.
>브라우저 환경을 그림으로 표현하면 아래와 같습니다.

![image](https://github.com/Ryan-Dia/Javascript-Deep-Dive-Study/assets/76567238/a73380c2-28e4-47af-ae60-6f267f18d53b)

- 구글의 V8 자바스크립트 엔진을 비롯한 대부분의 자바스크립트 엔진은 크게 2개의 영역으로 구분할 수 있습니다.

- 📌 콜스택
  - 소스코드(전역 코드나 함수 코드 등) 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택이 바로 콜 스택입니다.
  - 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행됩니다.
  - 자바스크립트 엔진은 단 하나의 콜스택을 사용하기 때문에 최상위 실행 컨텍스트(실행 중인 실행 컨텍스트)가 종료되어 콜 스택에서 제거되기 전까지는 다른 어떤 태스크도 실행되지 않습니다.
- 📌 힙
  - 힙은 객체가 저장되는 메모리 공간입니다.
  - 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조합니다.
  - 메모리에 값을 저장하려면 먼저 값을 저장할 메모리 공간의 크기를 결정해야 합니다.
  - 객체는 원시 값과 달리 크기가 정해져 있지 않으므로 할당해야 할 메모리 공간의 크기를 런타임에 결정(동적 할당)해야 합니다.
  - 따라서 객체가 저장되는 메모리 공강긴 힙은 구조화 되어 있지 않다는 특징이 있습니다.
 

자바스크립트 엔진은 단순히 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행할 뿐입니다. 비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 `Node.js`가 담당합니다.    


<br>

자바스크립트는 싱글 스레드 방식으로 동작합니다. 이때 싱글 스레드 방식으로 동작하는 것은 브라우저가 아니라 브라우저에 내장된 자바스크립트 엔진이라는 것에 중의해야합니다. 만약 모든 자바스크립트 코드가 자바스크립트 엔진에서 싱글 스레드 방식으로 동작한다면 자바스크립트는 비동기로 동작할 수 없습니다. 즉 자바스크립트 엔진은 싱글 스레드로 동작하지만 브라우저는 멀티 스레드로 동작합니다.


